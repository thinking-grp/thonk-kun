name: Update programs
on:
  schedule:
    - cron: "30 4 * * *" # åˆå‰0æ™‚ã«å®Ÿè¡Œ(UTCåŸºæº–ãªã®ã§9æ™‚é–“å¼•ã)
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0
          submodules: recursive
      - name: Use Node.js 16.x
        uses: actions/setup-node@v1
        with:
          node-version: 16.x
      - name: Copy myself
        working-directory: ./
        run: |
          mkdir thonk-kun.new
          mkdir thonk-kun.backup
          rsync -Rr ./* thonk-kun.backup/
          rsync -Rr ./* thonk-kun.new/
          rm -rf ./thonk-kun.new/thonk-kun.backup/
          rm -rf ./thonk-kun.new/thonk-kun.new/
          rm -rf ./thonk-kun.backup/thonk-kun.backup/
          rm -rf ./thonk-kun.backup/thonk-kun.new/

      - name: Clean myself
        working-directory: ./
        run: |
          # ç‰¹å®šã®ãƒ•ã‚©ãƒ«ãƒ€3ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ

          exclude_folders=(.github src .gitignore)


          # ç‰¹å®šã®ãƒ•ã‚©ãƒ«ãƒ€1å†…ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒªã‚¹ãƒˆã‚’ä½œæˆ

          folders=($(find thonk-kun.new -mindepth 1 -maxdepth 1 -type d -printf '%f\n'))


          # ç‰¹å®šã®ãƒ•ã‚©ãƒ«ãƒ€3ä»¥å¤–ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤

          for folder in "${folders[@]}"; do
            if [[ ! " ${exclude_folders[@]} " =~ " ${folder} " ]]; then
              rm -rf "thonk-kun.new/${folder}"
            fi
          done

          rm -f README_thinkerAI.md

          rm -f README_thinkReplyer.md
      - name: Checkout thinkerAI
        uses: actions/checkout@v3
        with:
          repository: thinking-grp/thinkerAI
          path: ./thonk-kun.new/thinkerAI
          ssh-key: ${{ secrets.THINKERAI_SSH_KEY }}
          ref: refs/heads/develop
      - name: Clean thinkerAI
        working-directory: ./thonk-kun.new/thinkerAI
        run: |
          rm -rf ./src/
          rm -rf ./docs/
          rm -rf ./python/
          rm -f ./install-darwin-x64.sh
          rm -f ./install-win32-x64.bat
          rm -f ./LICENSE
          mv README.md README_thinkerAI.md
      - name: Copy thinkerAI
        working-directory: ./thonk-kun.new/
        run: |
          rm -rf ./thinkerAI/.git 
          cp -ra ./thinkerAI/* ./
          rm -rf ./thinkerAI
      - name: Checkout thinkReplyer
        uses: actions/checkout@v3
        with:
          repository: thinking-grp/thinkReplyer
          path: ./thonk-kun.new/thinkReplyer
          ssh-key: ${{ secrets.THINKREPLYER_SSH_KEY }}
      - name: Copy thinkReplyer
        working-directory: ./thonk-kun.new
        run: |
          rm -rf ./thinkReplyer/.git 
          mv ./thinkReplyer/README.md ./README_thinkReplyer.md
          mkdir -p ./runtimes
          mkdir -p ./runtimes/thinkReplyer/
          cp -ra ./thinkReplyer/* ./runtimes/thinkReplyer/
          rm -rf ./thinkReplyer/
      - name: Test
        working-directory: ./thonk-kun.new
        run: |
          if ! diff -qr --speed-large-files ./ ../thonk-kun.backup >/dev/null 2>&1;
          then
            echo "Folder differences found."
            npm install
            npm test
          else
            echo "Folder contents are the same."
          fi
      - name: Set git config
        run: |
          git config --local user.email "mf7cli120@icloud.com"
          git config --local user.name "thinkerAI bot"

      - name: Commit
        working-directory: ./
        run: |
          if ! diff -qr ./thonk-kun.new ./thonk-kun.backup >/dev/null; then
            echo "Folder contents are different. Files changed:"
            diff -rab ./thonk-kun.new ./thonk-kun.backup
            exit 1

            rm -rf ./thonk-kun.backup
            cp -R ./thonk-kun.new/* ./
            rm -rf ./thonk-kun.new

            git add .
            git commit -q -m "ğŸ‰ thinkerAIã¨thinkReplyerã‚’æ›´æ–°ã—ã¾ã—ãŸï¼" -a
            git push origin HEAD:main
          else
            echo "Folder contents are the same."
          fi